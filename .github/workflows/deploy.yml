name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. å®‰è£… pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. æ„å»ºé¡¹ç›®
      - name: Build project
        run: pnpm run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: /api
          VITE_SOCKET_URL: https://onespecial.me/ws
          VITE_APP_TITLE: æ–‡æ¡£å¹³å°

      # 6. åˆ›å»ºéƒ¨ç½²åŒ…
      - name: Create deployment archive
        run: |
          cd dist
          tar -czf ../deploy.tar.gz .
          cd ..
          ls -lh deploy.tar.gz nginx.conf

      # 7. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"
          strip_components: 0

      - name: Deploy nginx config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "nginx.conf"
          target: "/tmp/"
          strip_components: 0

      # 8. è§£å‹å¹¶ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
      - name: Extract and move files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "ğŸ” å¼€å§‹éƒ¨ç½²æµç¨‹..."
            echo "ğŸ“ éƒ¨ç½²è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
            echo "ğŸ“… å½“å‰æ—¶é—´: $(date)"
            
            # æ£€æŸ¥éƒ¨ç½²è·¯å¾„å˜é‡
            if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
              echo "âŒ é”™è¯¯: DEPLOY_PATH æœªè®¾ç½®!"
              exit 1
            fi
            
            # æ£€æŸ¥å‹ç¼©åŒ…
            if [ ! -f "/tmp/deploy.tar.gz" ]; then
              echo "âŒ é”™è¯¯: /tmp/deploy.tar.gz ä¸å­˜åœ¨!"
              echo "ğŸ“‚ /tmp ç›®å½•å†…å®¹:"
              ls -lh /tmp/ | grep deploy || echo "æœªæ‰¾åˆ°deployç›¸å…³æ–‡ä»¶"
              exit 1
            fi
            echo "âœ… å‹ç¼©åŒ…å­˜åœ¨: $(ls -lh /tmp/deploy.tar.gz)"
            
            # æ£€æŸ¥éƒ¨ç½²è·¯å¾„
            if [ ! -d "${{ secrets.DEPLOY_PATH }}" ]; then
              echo "âš ï¸  éƒ¨ç½²è·¯å¾„ä¸å­˜åœ¨,å°†åˆ›å»º..."
              sudo mkdir -p "${{ secrets.DEPLOY_PATH }}" || {
                echo "âŒ åˆ›å»ºéƒ¨ç½²ç›®å½•å¤±è´¥!"
                exit 1
              }
            else
              echo "âœ… éƒ¨ç½²è·¯å¾„å­˜åœ¨"
              echo "ğŸ“‚ å½“å‰æ–‡ä»¶åˆ—è¡¨:"
              ls -lh "${{ secrets.DEPLOY_PATH }}/index.html" 2>/dev/null || echo "index.html ä¸å­˜åœ¨"
            fi
            
            # åˆ›å»ºå¤‡ä»½
            if [ -d "${{ secrets.DEPLOY_PATH }}" ] && [ "$(ls -A ${{ secrets.DEPLOY_PATH }})" ]; then
              echo "ğŸ’¾ Creating backup..."
              sudo rm -rf "${{ secrets.DEPLOY_PATH }}.backup"
              sudo cp -r "${{ secrets.DEPLOY_PATH }}" "${{ secrets.DEPLOY_PATH }}.backup" || echo "âš ï¸  å¤‡ä»½å¤±è´¥,ç»§ç»­éƒ¨ç½²..."
            fi
            
            # æ¸…ç©ºå½“å‰éƒ¨ç½²ç›®å½•
            echo "ğŸ—‘ï¸  æ¸…ç©ºéƒ¨ç½²ç›®å½•..."
            sudo rm -rf "${{ secrets.DEPLOY_PATH }}"/*
            
            # è§£å‹æ–°æ–‡ä»¶
            echo "ï¿½ è§£å‹æ–‡ä»¶åˆ° ${{ secrets.DEPLOY_PATH }}..."
            cd "${{ secrets.DEPLOY_PATH }}"
            sudo tar -xzf /tmp/deploy.tar.gz || {
              echo "âŒ è§£å‹å¤±è´¥!"
              # å°è¯•æ¢å¤å¤‡ä»½
              if [ -d "${{ secrets.DEPLOY_PATH }}.backup" ]; then
                echo "ğŸ”„ æ¢å¤å¤‡ä»½..."
                sudo cp -r "${{ secrets.DEPLOY_PATH }}.backup"/* "${{ secrets.DEPLOY_PATH }}/"
              fi
              exit 1
            }
            
            # éªŒè¯è§£å‹ç»“æœ
            if [ ! -f "${{ secrets.DEPLOY_PATH }}/index.html" ]; then
              echo "âŒ é”™è¯¯: index.html æœªæ‰¾åˆ°!"
              echo "ğŸ“‚ å®é™…è§£å‹çš„æ–‡ä»¶:"
              ls -la "${{ secrets.DEPLOY_PATH }}" | head -20
              exit 1
            fi
            
            echo "âœ… è§£å‹æˆåŠŸ!"
            echo "ğŸ“ è§£å‹åçš„æ–‡ä»¶:"
            ls -lh "${{ secrets.DEPLOY_PATH }}/index.html"
            echo "ğŸ“¦ Assetsæ–‡ä»¶:"
            ls -lh "${{ secrets.DEPLOY_PATH }}/assets/" | head -10
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/deploy.tar.gz
            
            # è®¾ç½®æƒé™
            echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data "${{ secrets.DEPLOY_PATH }}"
            sudo chmod -R 755 "${{ secrets.DEPLOY_PATH }}"
            
            # æ›´æ–°æ–‡ä»¶æ—¶é—´æˆ³
            echo "â° æ›´æ–°æ–‡ä»¶æ—¶é—´æˆ³..."
            sudo find "${{ secrets.DEPLOY_PATH }}" -type f -exec touch {} \;
            
            # æ¸…é™¤nginxç¼“å­˜
            echo "ğŸ§¹ æ¸…é™¤nginxç¼“å­˜..."
            if [ -d "/var/cache/nginx" ]; then
              sudo rm -rf /var/cache/nginx/*
              echo "âœ… nginxç¼“å­˜å·²æ¸…é™¤"
            fi
            
            # â­ æ›´æ–° Nginx é…ç½®(æ–°å¢)
            if [ -f "/tmp/nginx.conf" ]; then
              echo "ğŸ“ æ›´æ–°Nginxé…ç½®..."
              sudo cp /etc/nginx/sites-available/onespecial.me /etc/nginx/sites-available/onespecial.me.backup
              sudo cp /tmp/nginx.conf /etc/nginx/sites-available/onespecial.me
              
              echo "ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶æ›´æ–°:"
              echo "ETagè®¾ç½®: $(grep -c 'etag off' /etc/nginx/sites-available/onespecial.me || echo '0')"
              echo "if_modified_sinceè®¾ç½®: $(grep -c 'if_modified_since off' /etc/nginx/sites-available/onespecial.me || echo '0')"
              
              sudo nginx -t && echo "âœ… Nginxé…ç½®æµ‹è¯•é€šè¿‡" || {
                echo "âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥,æ¢å¤å¤‡ä»½"
                sudo cp /etc/nginx/sites-available/onespecial.me.backup /etc/nginx/sites-available/onespecial.me
                exit 1
              }
              rm -f /tmp/nginx.conf
            else
              echo "âš ï¸ /tmp/nginx.conf ä¸å­˜åœ¨,è·³è¿‡é…ç½®æ›´æ–°"
            fi
            
            # é‡å¯ Nginx (ä½¿ç”¨stop + startç¡®ä¿å®Œå…¨é‡å¯)
            echo "ğŸ”„ åœæ­¢nginx..."
            sudo systemctl stop nginx
            
            # å¼ºåˆ¶åˆ·æ–°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜
            echo "ğŸ’¾ åˆ·æ–°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜..."
            sync
            
            # ç­‰å¾…1ç§’ç¡®ä¿nginxå®Œå…¨åœæ­¢
            sleep 1
            
            echo "ğŸš€ å¯åŠ¨nginx..."
            sudo systemctl start nginx
            
            # ç­‰å¾…nginxå®Œå…¨å¯åŠ¨
            sleep 2
            
            # éªŒè¯nginxçŠ¶æ€
            if ! sudo systemctl is-active --quiet nginx; then
              echo "âŒ nginxå¯åŠ¨å¤±è´¥!"
              sudo systemctl status nginx
              exit 1
            fi
            
            # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            echo ""
            echo "=" "=" "=" "=" "=" "=" "=" "=" "=" "="
            echo "ğŸ“Š éƒ¨ç½²å®Œæˆ! æœ€ç»ˆçŠ¶æ€:"
            echo "=" "=" "=" "=" "=" "=" "=" "=" "=" "="
            echo "ğŸ“„ æ–‡ä»¶ä¿¡æ¯:"
            ls -lh ${{ secrets.DEPLOY_PATH }}/index.html
            echo ""
            echo "ğŸ“… æ–‡ä»¶ä¿®æ”¹æ—¶é—´: $(stat -c %y ${{ secrets.DEPLOY_PATH }}/index.html)"
            echo "ğŸŒ nginxçŠ¶æ€: $(sudo systemctl is-active nginx)"
            
            # éªŒè¯HTTPå“åº”(å¿½ç•¥é”™è¯¯)
            echo ""
            echo "ğŸ” HTTPå“åº”éªŒè¯:"
            curl -sI https://onespecial.me 2>/dev/null | head -15 || echo "âš ï¸ curléªŒè¯å¤±è´¥,ä½†éƒ¨ç½²å·²å®Œæˆ"
            
            echo ""
            echo "ğŸ“Š Nginxé…ç½®æ£€æŸ¥:"
            echo "- sites-availableé…ç½®: $(grep -c 'etag off' /etc/nginx/sites-available/onespecial.me 2>/dev/null || echo 'æœªæ‰¾åˆ°etag off')"
            echo "- ç¬¦å·é“¾æ¥çŠ¶æ€: $(ls -l /etc/nginx/sites-enabled/onespecial.me 2>/dev/null || echo 'ç¬¦å·é“¾æ¥ä¸å­˜åœ¨')"
            echo ""
            echo "âœ… Deployment completed successfully!"

      # 9. éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "${{ secrets.DEPLOY_PATH }}/index.html" ]; then
              echo "âœ… Deployment verified: index.html exists"
              ls -lh ${{ secrets.DEPLOY_PATH }}/index.html
            else
              echo "âŒ Deployment failed: index.html not found"
              exit 1
            fi
            
            # æ£€æŸ¥ Nginx çŠ¶æ€
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx is running"
            else
              echo "âŒ Nginx is not running"
              exit 1
            fi

      # 10. å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Deployment to onespecial.me succeeded!"
          else
            echo "âŒ Deployment to onespecial.me failed!"
          fi
