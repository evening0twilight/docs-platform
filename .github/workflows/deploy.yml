name: Deploy to Production

# è§¦å‘æ¡ä»¶:æ¨é€åˆ° main åˆ†æ”¯(é€šå¸¸æ˜¯ä» dev-pzj åˆå¹¶è¿‡æ¥)
on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. å®‰è£… pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. æ„å»ºé¡¹ç›®
      - name: Build project
        run: pnpm run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: /api

      # 6. åˆ›å»ºéƒ¨ç½²åŒ…
      - name: Create deployment archive
        run: |
          cd dist
          tar -czf ../deploy.tar.gz .
          cd ..

      # 7. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"

      # 8. è§£å‹å¹¶ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
      - name: Extract and move files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # åˆ›å»ºå¤‡ä»½
            if [ -d "${{ secrets.DEPLOY_PATH }}" ]; then
              echo "Creating backup..."
              sudo rm -rf ${{ secrets.DEPLOY_PATH }}.backup
              sudo cp -r ${{ secrets.DEPLOY_PATH }} ${{ secrets.DEPLOY_PATH }}.backup
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p ${{ secrets.DEPLOY_PATH }}
            
            # æ¸…ç©ºå½“å‰éƒ¨ç½²ç›®å½•
            sudo rm -rf ${{ secrets.DEPLOY_PATH }}/*
            
            # è§£å‹æ–°æ–‡ä»¶
            cd ${{ secrets.DEPLOY_PATH }}
            sudo tar -xzf /tmp/deploy.tar.gz
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/deploy.tar.gz
            
            # è®¾ç½®æƒé™
            sudo chown -R www-data:www-data ${{ secrets.DEPLOY_PATH }}
            sudo chmod -R 755 ${{ secrets.DEPLOY_PATH }}
            
            # é‡å¯ Nginx
            sudo systemctl reload nginx
            
            echo "Deployment completed successfully!"

      # 9. éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "${{ secrets.DEPLOY_PATH }}/index.html" ]; then
              echo "âœ… Deployment verified: index.html exists"
              ls -lh ${{ secrets.DEPLOY_PATH }}/index.html
            else
              echo "âŒ Deployment failed: index.html not found"
              exit 1
            fi
            
            # æ£€æŸ¥ Nginx çŠ¶æ€
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx is running"
            else
              echo "âŒ Nginx is not running"
              exit 1
            fi

      # 10. å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Deployment to onespecial.me succeeded!"
          else
            echo "âŒ Deployment to onespecial.me failed!"
          fi
